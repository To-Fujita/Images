<!DOCTYPE html>
<html>
  <title>Index.html for Chat Bot by T. Fujita 2021/5/10</title>
  <head>
    <link rel="stylesheet" type="text/css" href="./css/bot.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  </head>
  <body>
    <h1>ã€€
      <img src="./images/F021_R.png" alt="CANDICE" style="width:50px;height:50px;"/>
      ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆï¼ˆã‚ªãƒ¼ãƒ è¿”ã—ï¼‰ã€€
      <input style="position:absolute; top:10px; right:80px;" type="submit" value="éŸ³å£° ON/OFF" onclick="OnButtonClick_01();"> <textarea readonly id="speak" rows= "1" cols="4" style="vertical-align:bottom; position:absolute; top:10px; right:20px;">OFF</textarea>
      <input style="position:absolute; top:40px; right:80px;" type="submit" value="USER ç”·æ€§/å¥³æ€§" onclick="OnButtonClick_02();"> <textarea readonly id="user" rows= "1" cols="4" style="vertical-align:bottom; position:absolute; top:40px; right:20px;">ç”·æ€§</textarea>
    </h1>
    <div class="box"></div>
    <div class="boxed">
      <div>
        <div id="chatbox">
          <p class="botText">
            <img src="./images/F021_R.png" alt="BOT" style="width:50px;height:50px;"/>
            <span>ç§ã¯ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚ã€€ä½•ã‹è©±ã—ã‹ã‘ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼ŸğŸ’–</span>
          </p>
        </div>
        <div id="userInput">
          <input id="textInput" type="text" name="msg" placeholder="Message" />
        </div>
      </div>
      <script>
        let bot_icon = "./images/F021_R.png"
        let user_icon = "./images/M008_L.png"
        let Speak = document.getElementById('speak');
        let User = document.getElementById('user')
        const uttr = new SpeechSynthesisUtterance();

        SpeechRecognition = webkitSpeechRecognition || SpeechRecognition;
        let recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.interimResults = true;
        recognition.continuous = true;

// éŸ³å£°å…¥åŠ›ã€éŸ³å£°èªè­˜ã®ON/OFFè¨­å®š
        function OnButtonClick_01() {
          if (Speak.value == 'ON') {
            Speak.value ='OFF'
            recognition.stop();
          }
          else {
            Speak.value = 'ON'
            recognition.start();
          }
        }

// User Icon ã®è¨­å®š
        function OnButtonClick_02() {
          if (User.value == 'ç”·æ€§') {
            User.value ='å¥³æ€§'
            user_icon = "./images/F003_L.png"
          }
          else {
            User.value = 'ç”·æ€§'
            user_icon = "./images/M008_L.png"
          }
        }

// å…¥å‡ºåŠ›
        function getBotResponse() {
          var rawText = document.getElementById("textInput");
          var userHtml = '<p class="userText"><span>' + rawText.value + 
            '</span><img src=' + user_icon + ' alt="USER" style="width:50px;height:50px;"/></p>';
            var data = makeAnswer(rawText.value);
          $("#textInput").val("");
          $("#chatbox").append(userHtml);
          document.getElementById("userInput").scrollIntoView({ block: "start", behavior: "smooth" });
          var botHtml = '<p class="botText"><img src=' + bot_icon + ' alt="BOT" style="width:50px;height:50px;"/><span>' + data + '</span></p>';
          $("#chatbox").append(botHtml);
          speech(data);
          document.getElementById("userInput").scrollIntoView({ block: "start", behavior: "smooth" });
          if (Speak.value == 'ON' && !speechSynthesis.speaking){
            recognition.start();
          }
        }

// éŸ³å£°åˆæˆã§ã®ç™ºå£°
        function speech(answer) {
          if (Speak.value != 'ON') {return}
          uttr.text = answer;
          uttr.rate = 1.0;
          uttr.pitch = 1.0;
          speechSynthesis.speak(uttr) 
        }

// éŸ³å£°èªè­˜å‡¦ç†
        recognition.onresult = (event) => {
          let interimTranscript = '';     // æš«å®šã®èªè­˜çµæœï¼ˆAndroidã§ã¯ã€ã†ã¾ãæ©Ÿèƒ½ã—ãªã„ï¼‰
          let finalTranscript = '';       // ç¢ºå®šã—ãŸèªè­˜çµæœ
          question = '';
          if (speechSynthesis.speaking) {
            recognition.stop();
            answer = null;
            return;
          }      
          for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
              finalTranscript = event.results[i][0].transcript;
            } else {
              interimTranscript = '';
            }
          }
          question = finalTranscript;
          if (question.length > 0) {
            if (question != undefined) {
              document.getElementById("textInput").value = question;
              getBotResponse();
            }
          }        
        }

        uttr.start = (event) => {
          recognition.stop();
        }

        uttr.onend = (event) => {
          if (Speak.value == 'ON') {
            recognition.start();
          } 
        }

// Return Key å…¥åŠ›æ™‚ã®å‡¦ç†
        $("#textInput").keypress(function(e) {
          if (e.which == 13) {
            getBotResponse();
          }
        });

// è¿”ç­”ã®ä½œæˆ
        function makeAnswer(Temp_Text) {
          var temp = Temp_Text + 'ã€€ã§ã™ã­ï¼Ÿ';
          return temp;
        }

      </script>
    </div>
  </body>
</html>
